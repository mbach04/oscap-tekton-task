apiVersion: tekton.dev/v1alpha1
kind: PipelineResource
metadata:
  name: image-scan-resource
  namespace: default
spec:
  type: image
  params:
    - name: url
      value: quay.io/mbach/rstudio-centos7
---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: oscap-image-scan
spec:
  params:
  - name: xccdfProfile
    description: The oscap xccdf profile to use when calling the oscap-chroot command
    default: xccdf_org.ssgproject.content_profile_standard
  - name: oscapProfilePath
    description: The full path to the oscap content file 
    default: /usr/share/xml/scap/ssg/content/ssg-centos7-ds-1.2.xml
  - name: container-imagetag
    type: string
    default: "latest"
  resources:
    inputs:
      - name: container-image
        type: image
  workspaces:
  - name: report
    description: Storage for oscap report.html generated by oscap-chroot scan
  steps:
    - name: scan-image
      securityContext:
        privileged: true
      image: quay.io/redhatgov/image-scanner@sha256:cdc3713816e1d5d70a9cf43d2ffcfc45e7862e2004aa978bdb7a1a594ca8de9e
      command: ['/bin/bash']
      args:
        - -c
        - |
          echo "Pulling image $(inputs.resources.container-image.url)"
          buildah from --storage-driver vfs docker://$(inputs.resources.container-image.url):$(inputs.params.container-imagetag)
          container_id=$(buildah --storage-driver vfs containers -q)
          echo "Container ID: $container_id"
          echo "Mounting the container..."
          buildah mount --storage-driver vfs $container_id
          echo "Running oscap-chroot scan"
          oscap-chroot $(buildah --storage-driver vfs mount | awk '{print $2}') xccdf eval --profile $(inputs.params.xccdfProfile) --report $(workspaces.report.path)/report.html $(inputs.params.oscapProfilePath)
          #oscap-chroot $(buildah --storage-driver vfs mount | awk '{print $2}') xccdf eval --profile $(inputs.params.xccdfProfile) --report /tmp/report.html $(inputs.params.oscapProfilePath)
          echo "Displaying contents of $(workspaces.report.path)/report.html"
          echo "********** START OF report.html **********"
          cat $(workspaces.report.path)/report.html
          #cat /tmp/report.html
          echo "********** END OF report.html ************"
---
apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: oscap-scan-pipeline
spec:
  params:
    - name: xccdfProfile
      description: The oscap xccdf profile to use when calling the oscap-chroot command
    - name: oscapProfilePath
      description: The full path to the oscap content file
    - name: container-imagetag
      description: Tag of the image being scanned
  tasks:
    - name: scan
      taskRef: 
        name: oscap-image-scan
---
apiVersion: tekton.dev/v1beta1
kind: PipelineRun
metadata:
  generateName: oscap-run-
spec:
  pipelineRef:
    name: oscap-scan-pipeline
  workspaces:
    - name: ws
      volumeClaimTemplate:
        spec:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 10Mi
  params:
    - name: xccdfProfile
      value: xccdf_org.ssgproject.content_profile_standard
    - name: oscapProfilePath
      value: /usr/share/xml/scap/ssg/content/ssg-centos7-ds-1.2.xml
    - name: container-imagetag
      value: "latest"
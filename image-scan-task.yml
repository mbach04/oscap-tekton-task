apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: oscap-image-scan
spec:
  params:
  - name: xccdfProfile
    description: The oscap xccdf profile to use when calling the oscap-chroot command
    default: xccdf_org.ssgproject.content_profile_standard
  - name: oscapProfilePath
    description: The full path to the oscap content file 
    default: /usr/share/xml/scap/ssg/content/ssg-centos7-ds-1.2.xml
  - name: container-imagetag
    type: string
    default: "latest"
  resources:
    inputs:
      - name: container-image
        type: image
  # workspaces:
  # - name: report
  #   readOnly: false
  #   description: Storage for oscap report.html generated by oscap-chroot scan
  steps:
    - name: scan-image
      securityContext:
        privileged: true
      image: quay.io/redhatgov/image-scanner@sha256:cdc3713816e1d5d70a9cf43d2ffcfc45e7862e2004aa978bdb7a1a594ca8de9e
      command: ['/bin/bash']
      args:
        - -c
        - |
          echo "Pulling image $(inputs.resources.container-image.url)"
          buildah from --storage-driver vfs docker://$(inputs.resources.container-image.url):$(inputs.params.container-imagetag)
          container_id=$(buildah --storage-driver vfs containers -q)
          echo "$container_id"
          buildah mount --storage-driver vfs $container_id
          echo "Running oscap-chroot scan"
          # oscap-chroot $(buildah --storage-driver vfs mount | awk '{print $2}') xccdf eval --profile $(inputs.params.xccdfProfile) --report $(workspaces.report.path)/report.html $(inputs.params.oscapProfilePath)
          oscap-chroot $(buildah --storage-driver vfs mount | awk '{print $2}') xccdf eval --profile $(inputs.params.xccdfProfile) --report /tmp/report.html $(inputs.params.oscapProfilePath)
          # echo "Displaying contents of $(workspaces.report.path)/report.html"
          echo "********** START OF report.html **********"
          # cat $(workspaces.report.path)/report.html
          cat /tmp/report.html
          echo "********** END OF report.html ************"